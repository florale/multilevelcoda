---
title: "Compositional Multilevel Substitution Model"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Compositional Multilevel Substitution Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "CairoPNG", dpi = 150, fig.path = "mlmcoda-"
)
```

Substitution models is a useful post-hoc analysis for regression models with compositional predictors. 
Results from our main `brms`model tell us how each behaviour is associated with an outcome. However,
we often are also interested in the changes in an outcomes when a fixed duration of time is reallocated
from one behaviour to another, while the other behaviours remain constant.

The Compositional Isotemporal Substitution Model (Dumuid et al., 2019) can be used to estimate this 
change. The `multilevelcoda` package implements this method in a multilevel framework and offers functions 
for both between- and within-person levels of variability. We dive into 4 different substitution models
in this vignette.

We will begin by loading necessary packages, `multilevelcoda`, `brms` (for models fitting),
doFuture (for parallelisation) and datasets `mcompd` (simulated compositional sleep and wake variables),
`sbp` (sequential binary partition), and `psub` (base possible substitution).

```{r setup}
library(multilevelcoda)
library(brms)
library(doFuture)

data("mcompd") 
data("sbp")
data("psub")

options(digits = 3) # reduce number of digits shown
```

Let's fit our main `brms` model predicting \code{STRESS} from both between and within-person
sleep-wake behaviours (represented by isometric log ratio coordinates), with sex as a covariate, 
using the `brmcoda()` function. We can compute ILR coordinate predictors using `compilr()` function.

```{r, results = "hide"}

cilr <- compilr(data = mcompd, sbp = sbp,
                parts = c("TST", "WAKE", "MVPA", "LPA", "SB"), idvar = "ID")

m <- brmcoda(compilr = cilr,
             formula = STRESS ~ bilr1 + bilr2 + bilr3 + bilr4 +
               wilr1 + wilr2 + wilr3 + wilr4 + Female + (1 | ID),
             cores = 8, seed = 123, backend = "cmdstanr")
```

A `summary()` of the model results.

```{r}
summary(m$Model)
```

We can see that the first and forth within-person ILR coordinates were both associated with stress. 
Multilevel ILR coordinates are sometimes a pain to interpret. For example,  the significant coefficient 
for wilr1 shows that the within-person change in sleep behaviours (sleep duration and time awake in 
bed combined), relative to wake behaviours (moderate to vigorous physical activity, light physical 
activity, and sedentary behaviour) on a given day, was associated with stress. However, as there are
several behaviours involved in this coordinate, we don't know the within-person change in which of 
them drives the association. It could be the change in sleep, such that people sleep more than their 
own average on a given day, but it could also be the change in time awake. Further, we don't know 
about the specific changes in time spent across behaviours. That is, if people slept more, what 
behaviour did they spend less time in?

This is common issue when working with multilevel compositional data as ILR coordinates often 
contains information about multiple compositional components. It is further inconvenient in the case of 
within-person ILR coordinates, as they represent the deviation from the mean (between-person) ILR 
coordinates. To gain further insights into these associations and help with interpretation, let's 
explore substitution models from our `multilevel` package.

## Substitution models

The \code{multilevelcoda} provides `4` different functions to compute substitution models.

Basic substitution model
- Between-person substitution model
- Within-person substitution model

Average marginal substitution model
- Average Marginal Effects for between-person substitution model
- Average Marginal Effects for within-person substitution model

*Tips*: Substitution models are often computationally demanding tasks. You can speed up the models using 
parallelisation, for example, using `doFuture` package.

### Basic substitution model

Between-person substitution model can be computed using the `bsub()` function. The below example 
examines the changes in stress for different pairwise substitution of sleep-wake behaviours
for a period of 1 to 5 minutes, at between-person level. As we have sex as covariate, `bsub()`
returns results for both males and females as the default. 

*Tips*: You can choose to average the results across sexes by specifying \code{summary = TRUE},
see next section for an example.

```{r}
bsubm1 <- bsub(objec = m, substitute = psub, minute = 5)
```

Output from `bsub()` contains multiple dataset of results for all available compositional component. 
Here are the results for changes in stress when sleep (TST) is substituted for 5 minutes for both 
males (Female = 0) and females (Female = 1). For ease of presentation, we only show the $\pm5$ minute 
substitution results, but the full dataset would contain similar results for 1, 2, etc. minute substitutions.

```{r, results = "asis"}
knitr::kable(bsubm1$TST[abs(MinSubstituted) == 5])
```

None of them are significant, given that the credible intervals did not cross 0, showing that 
increasing sleep (TST) at the expense of any other behaviours was not associated in changes in stress.

These results can be plotted to see the patterns more easily using the `plotsub()` function.

```{r mlmcoda-bstresstst, fig.width = 9, fig.height = 6}
plotsub(data = bsubm1$TST, x = "sleep", y = "stress")
```

### Within-person substitution model

Let's now take a look at how stress changes when different pairwise of sleep-wake behaviours are
substituted for a period of 1 to 5 minutes, at within-person level. 
What if we want to average our prediction by sex? Let's do that by adding 
an additional argument \code{summary = TRUE} to `bsub()`.

```{r}
# Within-person substitution
wsubm1 <- wsub(objec = m, substitute = psub, minute = 5, summary = TRUE)
``` 

Results for 5 minute substitution.

```{r, results = "asis"}
knitr::kable(wsubm1$TST[abs(MinSubstituted) == 5])
```

At within-person level, we got some significant results for substitution of sleep (TST) and time 
awake in bed (WAKE) for 5 minutes, but not other behaviours. Increasing sleep at the expense of time spent awake 
in bed predicted 0.02 higher stress [95% CI 0.00, 0.03], on a given day. Conversely, less sleep and 
more time awake in bed predicted less stress (b = -0.016 [95% CI -0.03,	-0.00]). Notice there is no 
column indicating the levels of convariates, indicating that these results have been averaged. 

Let's also plot theses results.

```{r mlmcoda-wstresstst, fig.width = 9, fig.height = 6}
plotsub(data = wsubm1$TST, x = "sleep", y = "stress")
``` 

### Average Marginal Substitution Effects 

Average marginal effect is (Josh help...)

`bsubmargins()` and `wsubmargins()` computes the changes in an outcome when 

Both of these models are generally more computationally expensive
. We can run our models faster in shorter walltime using parallelisation.

#### Estimating average marginal effect for between-person substitution

In this example, we use package `doFuture` for parallelisation. `bsubmargins()` will run 5 
substitution models for 5 sleep-wake behaviours, so we will parallel them across 5 workers.

*Note*: parallelisation is highly recommended, but optional.

```{r}
registerDoFuture()
plan(multisession, workers = 5)
```

```{r}
bsubm2 <- bsubmargins(object = m, substitute = psub, minute = 5)
knitr::kable(bsubm2$TST[abs(MinSubstituted) == 5])
```

#### Estimating average marginal effect for within-person substitution

```{r}
wsubm2 <- wsubmargins(object = m, substitute = psub, minute = 5)
knitr::kable(wsubm2$TST[abs(MinSubstituted) == 5])

registerDoSEQ()
```

A comparison between between- and within-person substitution model of sleep on stress, 
plot using `plotsub()` and `ggpubr::ggarrange()` functions.

```{r, fig.width = 9, fig.height = 7}
library(ggpubr)
p1 <- plotsub(data = bsubm2$TST, x = "between-person sleep", y = "stress")
p2 <- plotsub(data = wsubm2$TST, x = "within-person sleep", y = "stress")

ggarrange(p1, p2, 
          ncol = 1, nrow = 2)
```
