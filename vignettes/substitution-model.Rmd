---
title: "Compositional Multilevel Substitution Models"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Compositional Multilevel Substitution Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



# Intro
Substitution model is a useful post-hoc analysis for regression models with compositional predictors. 
Results from our main `brms` model tell us how each compositional predictor (expressed as ILR coordiante) 
is associated with an outcome. However,
we often are also interested in the changes in an outcomes when a fixed duration of time is reallocated
from one compositional component to another, while the other components remain constant.

The Compositional Isotemporal Substitution Model can be used to estimate this change. 
The `multilevelcoda` package implements this method in a multilevel framework and offers functions 
for both between- and within-person levels of variability. We discuss 4 different substitution models in this vignette.

We will begin by loading necessary packages, `multilevelcoda`, `brms` (for models fitting),
doFuture (for parallelisation), 
and datasets `mcompd` (simulated compositional sleep and wake variables),
`sbp` (sequential binary partition), and `psub` (base possible substitution).


```r
library(multilevelcoda)
library(brms)
library(doFuture)

data("mcompd") 
data("sbp")
data("psub")

options(digits = 3) # reduce number of digits shown
```

# Fitting main model
Let's fit our main `brms` model predicting `STRESS` from both between and within-person
sleep-wake behaviours (represented by isometric log ratio coordinates), with sex as a covariate, 
using the `brmcoda()` function. We can compute ILR coordinate predictors using `compilr()` function.


```r
cilr <- compilr(data = mcompd, sbp = sbp,
                parts = c("TST", "WAKE", "MVPA", "LPA", "SB"), idvar = "ID")

m <- brmcoda(compilr = cilr,
             formula = STRESS ~ bilr1 + bilr2 + bilr3 + bilr4 +
                                wilr1 + wilr2 + wilr3 + wilr4 + Female + (1 | ID),
             cores = 8, seed = 123, backend = "cmdstanr")
#> Compiling Stan program...
#> Start sampling
```

A `summary()` of the model results.


```r
summary(m$Model)
#>  Family: gaussian 
#>   Links: mu = identity; sigma = identity 
#> Formula: STRESS ~ bilr1 + bilr2 + bilr3 + bilr4 + wilr1 + wilr2 + wilr3 + wilr4 + Female + (1 | ID) 
#>    Data: tmp (Number of observations: 3540) 
#>   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
#>          total post-warmup draws = 4000
#> 
#> Group-Level Effects: 
#> ~ID (Number of levels: 266) 
#>               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> sd(Intercept)     0.99      0.06     0.87     1.11 1.00     1574     2552
#> 
#> Population-Level Effects: 
#>           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> Intercept     2.62      0.49     1.66     3.58 1.00     1345     2241
#> bilr1         0.11      0.31    -0.48     0.73 1.00     1126     2074
#> bilr2         0.52      0.33    -0.13     1.20 1.00     1366     1982
#> bilr3         0.13      0.22    -0.30     0.55 1.00     1126     1436
#> bilr4         0.02      0.28    -0.54     0.55 1.00      922     1831
#> wilr1        -0.34      0.12    -0.58    -0.11 1.00     3041     2537
#> wilr2         0.05      0.13    -0.21     0.30 1.00     3208     3224
#> wilr3        -0.11      0.08    -0.26     0.05 1.00     3269     3139
#> wilr4         0.24      0.10     0.04     0.44 1.00     3279     2873
#> Female       -0.39      0.17    -0.71    -0.06 1.00     1515     2370
#> 
#> Family Specific Parameters: 
#>       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
#> sigma     2.37      0.03     2.31     2.43 1.00     5233     2780
#> 
#> Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
#> and Tail_ESS are effective sample size measures, and Rhat is the potential
#> scale reduction factor on split chains (at convergence, Rhat = 1).
```

We can see that the first and forth within-person ILR coordinates were both associated with stress. 
Interpretation for multilevel ILR coordinates can often be less intuitive. 
For example, the significant coefficient for wilr1 shows that the within-person change in sleep behaviours 
(sleep duration and time awake in bed combined), relative to wake behaviours 
(moderate to vigorous physical activity, light physical activity, and sedentary behaviour) on a given day, 
is associated with stress. However, as there are
several behaviours involved in this coordinate, we don't know the within-person change in which of 
them drives the association. It could be the change in sleep, such that people sleep more than their 
own average on a given day, but it could also be the change in time awake. Further, we don't know 
about the specific changes in time spent across behaviours. That is, if people sleep more, what 
behaviour do they spend less time in?

This is common issue when working with multilevel compositional data as ILR coordinates often 
contains information about multiple compositional components. 
It is further inconvenient in the case of within-person ILR coordinates, as they represent the deviation from the mean (between-person) ILR coordinates. 
To gain further insights into these associations and help with interpretation, we can conduct 
post-hoc analyses using the substitution models from our `multilevel` package.

# Substitution models

`multilevelcoda` package provides `4` different functions to compute substitution models.

Basic substitution model:

- Between-person substitution model
- Within-person substitution model

Average marginal substitution model:

- Average marginal between-person substitution model
- Average marginal within-person substitution model

*Tips*: Substitution models are often computationally demanding tasks. 
You can speed up the models using parallelisation, for example, using `doFuture` package.

## Basic substitution model
We can calculate the changes in an outcomes when compositional variables are 
substituted for a specific of time using `bsub()` (between-person level) and `wsub()` (within-person level).
Both functions use sample's compositional mean as reference (i.e., composition when there is no change).

### Between-person substitution model
Between-person substitution model can be computed using the `bsub()` function. The below example 
examines the changes in stress for different pairwise substitution of sleep-wake behaviours
for a period of 1 to 5 minutes, at between-person level. If your model contains covariates, `bsub()` 
will average predictions across levels of covariates as the default.


```r
bsubm1 <- bsub(objec = m, substitute = psub, minute = 5)
#> Error: MultisessionFuture (doFuture-1) failed to call grmall() on cluster RichSOCKnode #4 (PID 1937 on 'localhost'). The reason reported was 'error writing to connection'. Post-mortem diagnostic: Detected a non-exportable reference ('externalptr') in one of the globals ('substitute' of class 'data.table') used in the future expression. The total size of the 50 globals exported is 20.73 MiB. The three largest globals are 'object' (18.75 MiB of class 'list'), 'setDT' (522.51 KiB of class 'function') and 'clo' (281.16 KiB of class 'function')
```

Output from `bsub()` contains multiple dataset of results for all available compositional component. 
Here are the results for changes in stress when sleep (TST) is substituted for 5 minutes. 
For ease of presentation, we only show the $\pm5$ minute 
substitution results, but the full dataset would contain similar results for 1, 2, etc. minute substitutions.


```r
knitr::kable(bsubm1$TST[abs(MinSubstituted) == 5])
```



|   Mean| CI_low| CI_high| MinSubstituted|Substitute |Predictor |
|------:|------:|-------:|--------------:|:----------|:---------|
|  0.031| -0.001|   0.064|              5|WAKE       |TST       |
|  0.003| -0.014|   0.019|              5|MVPA       |TST       |
|  0.006| -0.007|   0.017|              5|LPA        |TST       |
|  0.007| -0.007|   0.021|              5|SB         |TST       |
| -0.029| -0.060|   0.001|             -5|WAKE       |TST       |
| -0.003| -0.019|   0.013|             -5|MVPA       |TST       |
| -0.006| -0.018|   0.007|             -5|LPA        |TST       |
| -0.007| -0.021|   0.007|             -5|SB         |TST       |

None of them are significant, given that the credible intervals did not cross 0, showing that 
increasing sleep (TST) at the expense of any other behaviours was not associated 
in changes in stress at between-person level.

These results can be plotted to see the patterns more easily using the `plotsub()` function.


```r
plotsub(data = bsubm1$TST, x = "sleep", y = "stress")
```


<img src="mlmcoda-mlmcoda-plotbsubm1-1.png" title="Example of Between-person Substitution Model" alt="Example of Between-person Substitution Model" style="display: block; margin: auto;" />

### Within-person substitution model

Let's now take a look at how stress changes when different pairwise of sleep-wake behaviours are
substituted for a period of 1 to 5 minutes, at within-person level. 
We can obtain prediction for each level of covariates by adding 
an argument `summary = FALSE` to `wsub()`.


```r
wsubm1 <- wsub(objec = m, substitute = psub, minute = 5, summary = FALSE)
#> Error: MultisessionFuture (doFuture-1) failed to call grmall() on cluster RichSOCKnode #4 (PID 1937 on 'localhost'). The reason reported was 'error writing to connection'. Post-mortem diagnostic: Detected a non-exportable reference ('externalptr') in one of the globals ('substitute' of class 'data.table') used in the future expression. The total size of the 50 globals exported is 20.73 MiB. The three largest globals are 'object' (18.75 MiB of class 'list'), 'setDT' (522.51 KiB of class 'function') and 'clo' (281.16 KiB of class 'function')
```

Results for 5 minute substitution for each level of covariates. In this example, we get separate 
predictions for males and females.


```r
knitr::kable(wsubm1$TST[abs(MinSubstituted) == 5])
```



|   Mean| CI_low| CI_high| MinSubstituted|Substitute |Predictor | Female|
|------:|------:|-------:|--------------:|:----------|:---------|------:|
|  0.017|  0.003|   0.032|              5|WAKE       |TST       |      0|
| -0.003| -0.009|   0.003|              5|MVPA       |TST       |      0|
| -0.005| -0.009|   0.000|              5|LPA        |TST       |      0|
| -0.002| -0.007|   0.003|              5|SB         |TST       |      0|
| -0.016| -0.029|  -0.003|             -5|WAKE       |TST       |      0|
|  0.003| -0.003|   0.009|             -5|MVPA       |TST       |      0|
|  0.005|  0.000|   0.009|             -5|LPA        |TST       |      0|
|  0.002| -0.003|   0.007|             -5|SB         |TST       |      0|
|  0.017|  0.003|   0.032|              5|WAKE       |TST       |      1|
| -0.003| -0.009|   0.003|              5|MVPA       |TST       |      1|
| -0.005| -0.009|   0.000|              5|LPA        |TST       |      1|
| -0.002| -0.007|   0.003|              5|SB         |TST       |      1|
| -0.016| -0.029|  -0.003|             -5|WAKE       |TST       |      1|
|  0.003| -0.003|   0.009|             -5|MVPA       |TST       |      1|
|  0.005|  0.000|   0.009|             -5|LPA        |TST       |      1|
|  0.002| -0.003|   0.007|             -5|SB         |TST       |      1|

At within-person level, we got some significant results for substitution of sleep (TST) and time 
awake in bed (WAKE) for 5 minutes for both males and females, but not other behaviours. 
For males (Female = 0), increasing 5 minutes in sleep at the expense of time spent awake 
in bed predicted 0.02 higher stress [95% CI 0.00, 0.03], on a given day. Conversely, less sleep and 
more time awake in bed predicted less stress (b = -0.02 [95% CI -0.03,	-0.00]). 

Let's also plot theses results.


```r
plotsub(data = wsubm1$TST, x = "sleep", y = "stress")
```


<img src="mlmcoda-mlmcoda-plotwsubm1-1.png" title="Example of Within-person Substitution Model" alt="Example of Within-person Substitution Model" style="display: block; margin: auto;" />

## Average Marginal Substitution Effects

While `bsub()` and `wsub()` estimate the substitution model from the sample's compositional mean, 
`bsubmargins()` and `wsubmargins()` estimate the substitution model using the average effect of participant's compositional mean. 
That is, for each participant, `bsubmargins()` and `wsubmargins()` compute the changes in the outcome 
when a fixed duration of time is reallocated from one compositional component to another, 
while the other components remain constant and then average across the 
resulting effect estimates. 

`bsubmargins()` and `wsubmargins()` are generally more computationally expensive than `bsub()` and `wsub()` models. 
All models can be run faster in shorter walltime using parallelisation.

### Estimating average marginal effect for between-person substitution

In this example, we use package `doFuture` for parallelisation. `bsubmargins()` will run 5 
substitution models for 5 sleep-wake behaviours, so we will parallel them across 5 workers.


```r
registerDoFuture()
plan(multisession, workers = 5)
```


```r
bsubm2 <- bsubmargins(object = m, substitute = psub, minute = 5)
knitr::kable(bsubm2$TST[abs(MinSubstituted) == 5])
```



|   Mean| CI_low| CI_high| MinSubstituted|Substitute |Predictor |
|------:|------:|-------:|--------------:|:----------|:---------|
|  0.036| -0.002|   0.075|              5|WAKE       |TST       |
|  0.002| -0.016|   0.021|              5|MVPA       |TST       |
|  0.006| -0.007|   0.018|              5|LPA        |TST       |
|  0.008| -0.007|   0.023|              5|SB         |TST       |
| -0.033| -0.068|   0.001|             -5|WAKE       |TST       |
| -0.003| -0.020|   0.015|             -5|MVPA       |TST       |
| -0.006| -0.018|   0.007|             -5|LPA        |TST       |
| -0.008| -0.023|   0.007|             -5|SB         |TST       |

### Estimating average marginal effect for within-person substitution


```r
wsubm2 <- wsubmargins(object = m, substitute = psub, minute = 5)
knitr::kable(wsubm2$TST[abs(MinSubstituted) == 5])
```



|   Mean| CI_low| CI_high| MinSubstituted|Substitute |Predictor |
|------:|------:|-------:|--------------:|:----------|:---------|
|  0.021|  0.004|   0.038|              5|WAKE       |TST       |
| -0.003| -0.010|   0.003|              5|MVPA       |TST       |
| -0.005| -0.010|   0.000|              5|LPA        |TST       |
| -0.002| -0.007|   0.003|              5|SB         |TST       |
| -0.018| -0.033|  -0.003|             -5|WAKE       |TST       |
|  0.003| -0.003|   0.010|             -5|MVPA       |TST       |
|  0.005|  0.000|   0.010|             -5|LPA        |TST       |
|  0.002| -0.003|   0.007|             -5|SB         |TST       |

```r
registerDoSEQ()
```

A comparison between between- and within-person substitution model of sleep on stress, 
plot using `plotsub()` and `ggpubr::ggarrange()` functions.


```r
library(ggpubr)
p1 <- plotsub(data = bsubm2$TST, x = "between-person sleep", y = "stress")
p2 <- plotsub(data = wsubm2$TST, x = "within-person sleep", y = "stress")

ggarrange(p1, p2, 
          ncol = 1, nrow = 2)
```



```
#> Loading required package: ggplot2
#> 
#> Attaching package: 'ggpubr'
#> The following object is masked from 'package:cowplot':
#> 
#>     get_legend
```

<img src="mlmcoda-mlmcoda-submargins-1.png" title="Example of Average Marginal Substitution Model" alt="Example of Average Marginal Substitution Model" style="display: block; margin: auto;" />
