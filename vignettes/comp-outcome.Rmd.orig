---
title: "Multilevel Model with Compositional Outcomes"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Multilevel Model with Compositional Outcomes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "CairoPNG", dpi = 150, fig.path = "mlmcoda-"
)
```

In this vignette, we discuss how to specify multilevel models with compositional outcomes using `multilevelcoda`.

In addition to `multilevelcoda`, we will use `brms` package (to fit models) and
`bayestestR` package (to compute useful indices and compare models).

```{r setup}
library(multilevelcoda)
library(brms)
library(bayestestR)

options(digits = 3)
```

We will also attach built in datasets `mcompd` (simulated compositional sleep and wake variables) 
and `sbp` (sequential binary partition).

```{r data}
data("mcompd") 
data("sbp") 
```

## Getting compositions and isometric log ratio (ILR) coordinates. 

Compositional data are often expressed as a set of ILR coordinates in regression models (cite).
Using the `compilr()` function, we can get ILR coordinates 
that are used in the subsequent model as the predictors or outcomes.

```{r}
cilr <- compilr(data = mcompd, sbp = sbp,
                parts = c("TST", "WAKE", "MVPA", "LPA", "SB"), idvar = "ID")
```

## Multilevel model with compositional outcomes.

A model with multilevel compositional outcomes is multivariate, as it has multiple ILR coordinate outcomes,
each of which is predicted by a set of predictors. 
As usual, the ILR coordinates outcomes can be calculated using the `compilr()` functions.

```{r}
head(cilr$TotalILR)
```

Our `brms` model can be then fitted using the `brmcoda()` function.

```{r, results = "hide"}
mv <- brmcoda(compilr = cilr,
              formula = mvbind(ilr1, ilr2, ilr3, ilr4) ~ STRESS + (1 | ID),
              cores = 8, seed = 123, backend = "cmdstanr")
```

Here is a `summary()` of the model.

```{r}
summary(mv$Model)
```

We can see that stress significantly predicted `ilr1` and `ilr2`. 

## Bayes factor for compositional multilevel modelling

We are often interested in whether a predictor significantly predict the overall composition, in addition to the individual ILR coordinates. This can be done by comparing that model against the null, using Bayes factor. Let's examine whether stress predicts the overall sleep-wake composition.

In the frequentist approach, we usually compare the fits of models using \code{anova}.
In Bayesian, this can be done by comparing the marginal likelihoods of two models.

Bayes Factors (BFs) are indices of relative evidence of one model over another. 
In the context of compositional multilevel modelling, Bayes Factors provide two main useful functions:
- testing single parameters within a model
- comparing models 

We can utilize Bayes factors to answer the following question:

*"Which model is more likely to have produced the observed data?"*

*Note*: To use Bayes factors, `brmsfit` models must be fitted with an additional non-default argument
\code{save_pars = save_pars(all = TRUE)}.

```{r, message=FALSE, warning=FALSE}
# intercept only
mv0 <- brmcoda(compilr = cilr,
               formula = mvbind(ilr1, ilr2, ilr3, ilr4) ~ 1 + (1 | ID),
               iter = 6000, chains = 8, cores = 8, seed = 123, warmup = 1000,
               backend = "cmdstanr", save_pars = save_pars(all = TRUE))
# full model
mv <- brmcoda(compilr = cilr,
              formula = mvbind(ilr1, ilr2, ilr3, ilr4) ~ STRESS + (1 | ID),
              iter = 6000, chains = 8, cores = 8, seed = 123, warmup = 1000,
              backend = "cmdstanr", save_pars = save_pars(all = TRUE))
```

We can now compare these models with the `bayesfactor_models()` function

```{r}
bayesfactor_models(mv$Model, denominator = mv0$Model)
```

With a $BF$ of 1.87e-04 < 1, our data favours the intercept only model, showing that there is 
insufficient evidence for stress predicting the overall sleep-wake composition.

Bayes factors provide a intuitive measure of the strength of evidence of one model over the other
or among different models. Check out the `bayestestR` packages for several other useful functions related to BFs.

## References

Dumuid, D., Pedišić, Ž., Stanford, T. E., Martín-Fernández, J. A., Hron, K., Maher, C. A., ... & Olds, T. (2019). The compositional isotemporal substitution model: a method for estimating changes in a health outcome for reallocation of time between sleep, physical activity and sedentary behaviour. Statistical methods in medical research, 28(3), 846-857.

Egozcue, J. J., Pawlowsky-Glahn, V., Mateu-Figueras, G., & Barcelo-Vidal, C. (2003). Isometric logratio transformations for compositional data analysis. Mathematical geology, 35(3), 279-300.

