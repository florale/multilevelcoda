<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/5/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Improving MCMC Sampling for Bayesian Compositional Multilevel Models • multilevelcoda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Improving MCMC Sampling for Bayesian Compositional Multilevel Models">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">multilevelcoda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/A-introduction.html">Introduction to Bayesian Compositional Multilevel Modelling</a></li>
    <li><a class="dropdown-item" href="../articles/B-composition-MLM.html">Multilevel Models with Compositional Predictors</a></li>
    <li><a class="dropdown-item" href="../articles/C-composition-MMLM.html">Multilevel Model with Compositional Outcomes</a></li>
    <li><a class="dropdown-item" href="../articles/D-substitution.html">Compositional Substitution Multilevel Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/E-simmodel-diag.html">Improving MCMC Sampling for Bayesian Compositional Multilevel Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/florale/multilevelcoda/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>




      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Improving MCMC Sampling for Bayesian Compositional Multilevel Models</h1>
                        <h4 data-toc-skip class="author">Flora Le</h4>
            
            <h4 data-toc-skip class="date">2023-08-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/florale/multilevelcoda/blob/main/vignettes/E-simmodel-diag.Rmd" class="external-link"><code>vignettes/E-simmodel-diag.Rmd</code></a></small>
      <div class="d-none name"><code>E-simmodel-diag.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignettes, we present a case study we encountered in the
simulation study for package <code>multilevelcoda</code>. Briefly, we
found that multilevel model with compositional predictors with large
sample size, large between-person heterogeneity and small within-person
heterogeneity (large
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>σ</mi><mi>u</mi><mn>2</mn></msubsup><annotation encoding="application/x-tex">\sigma^2_{u}</annotation></semantics></math>
and small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>σ</mi><mi>ε</mi><mn>2</mn></msubsup><annotation encoding="application/x-tex">\sigma^2_{\varepsilon}</annotation></semantics></math>)
produced low bulk effective sample size (ESS). Here, we examined the
diagnostics of the model of interest and explored different methods to
improve the within-chain autocorrelation.</p>
</div>
<div class="section level2">
<h2 id="generating-data-from-simulation-study">Generating Data from Simulation Study<a class="anchor" aria-label="anchor" href="#generating-data-from-simulation-study"></a>
</h2>
<p>We first generated a dataset consisting of a 3-part behaviour
composition with 1200 individuals, 14 observations per individuals, and
large random intercept variation
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>u</mi><mn>2</mn></msubsup><mo>=</mo><mn>1.5</mn></mrow><annotation encoding="application/x-tex">\sigma^2_{u} = 1.5</annotation></semantics></math>),
coupled with small residual variation
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>ε</mi><mn>2</mn></msubsup><mo>:</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\sigma^2_{\varepsilon}: 0.5</annotation></semantics></math>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">sampled_cond</span> <span class="op">&lt;-</span> <span class="va">cond</span><span class="op">[</span><span class="va">condition</span> <span class="op">==</span> <span class="st">"RElarge_RESsmall"</span> <span class="op">&amp;</span> <span class="va">n_parts</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">N</span> <span class="op">==</span> <span class="fl">1200</span> <span class="op">&amp;</span> <span class="va">K</span> <span class="op">==</span> <span class="fl">14</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># condition</span></span>
<span><span class="va">N</span>             <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">N</span><span class="op">]</span></span>
<span><span class="va">K</span>             <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">K</span><span class="op">]</span></span>
<span><span class="va">rint_sd</span>       <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">rint_sd</span><span class="op">]</span></span>
<span><span class="va">res_sd</span>        <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">res_sd</span><span class="op">]</span></span>
<span><span class="va">run</span>           <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">run</span><span class="op">]</span></span>
<span><span class="va">n_parts</span>       <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">n_parts</span><span class="op">]</span></span>
<span><span class="va">sbp_n</span>         <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">sbp</span><span class="op">]</span></span>
<span><span class="va">prefit_n</span>      <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">prefit</span><span class="op">]</span></span>
<span><span class="va">groundtruth_n</span> <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">groundtruth</span><span class="op">]</span></span>
<span><span class="va">parts</span>         <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">parts</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># inputs</span></span>
<span><span class="va">sbp</span>           <span class="op">&lt;-</span> <span class="va">meanscovs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sbp_n</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">prefit</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">prefit_n</span><span class="op">)</span></span>
<span><span class="va">groundtruth</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">groundtruth_n</span><span class="op">)</span></span>
<span><span class="va">parts</span>         <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">parts</span>, <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">meanscovs</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">simulateData</span><span class="op">(</span></span>
<span>    bm <span class="op">=</span> <span class="va">BMeans</span>,</span>
<span>    wm <span class="op">=</span> <span class="va">WMeans</span>,</span>
<span>    bcov <span class="op">=</span> <span class="va">BCov</span>,</span>
<span>    wcov <span class="op">=</span> <span class="va">WCov</span>,</span>
<span>    n <span class="op">=</span> <span class="va">N</span>,</span>
<span>    k <span class="op">=</span> <span class="va">K</span>,</span>
<span>    psi <span class="op">=</span> <span class="va">psi</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simd</span><span class="op">[</span>, <span class="va">Sleep</span> <span class="op">:=</span> <span class="va">TST</span> <span class="op">+</span> <span class="va">WAKE</span><span class="op">]</span></span>
<span><span class="va">simd</span><span class="op">[</span>, <span class="va">PA</span> <span class="op">:=</span> <span class="va">MVPA</span> <span class="op">+</span> <span class="va">LPA</span><span class="op">]</span></span>
<span><span class="co"># ILR ---------------------------------------------------</span></span>
<span><span class="va">cilr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compilr.html">compilr</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">simd</span>,</span>
<span>  sbp <span class="op">=</span> <span class="va">sbp</span>,</span>
<span>  parts <span class="op">=</span> <span class="va">parts</span>,</span>
<span>  idvar <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cilr</span><span class="op">$</span><span class="va">data</span>,</span>
<span>             <span class="va">cilr</span><span class="op">$</span><span class="va">BetweenILR</span>,</span>
<span>             <span class="va">cilr</span><span class="op">$</span><span class="va">WithinILR</span>,</span>
<span>             <span class="va">cilr</span><span class="op">$</span><span class="va">TotalILR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># random effects ----------------------------------------</span></span>
<span><span class="va">redat</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span>ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span>,</span>
<span>                    rint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>                      n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      mean <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                      sd <span class="op">=</span> <span class="va">rint_sd</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="va">redat</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># outcome -----------------------------------------------</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">n_parts</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span><span class="op">[</span>, <span class="va">sleepy</span> <span class="op">:=</span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">simd</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="va">groundtruth</span><span class="op">$</span><span class="va">b_Intercept</span>  <span class="op">+</span> <span class="va">rint</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_bilr1</span> <span class="op">*</span> <span class="va">bilr1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_bilr2</span> <span class="op">*</span> <span class="va">bilr2</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_wilr1</span> <span class="op">*</span> <span class="va">wilr1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_wilr2</span> <span class="op">*</span> <span class="va">wilr2</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="va">res_sd</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span>           </span>
<span><span class="va">simd</span><span class="op">$</span><span class="va">sleepy</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">sleepy</span></span>
<span></span>
<span><span class="va">cilr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compilr.html">compilr</a></span><span class="op">(</span><span class="va">simd</span>, <span class="va">sbp</span>, <span class="va">parts</span>, total <span class="op">=</span> <span class="fl">1440</span>, idvar <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cilr</span><span class="op">$</span><span class="va">data</span>, <span class="va">cilr</span><span class="op">$</span><span class="va">BetweenILR</span>, <span class="va">cilr</span><span class="op">$</span><span class="va">WithinILR</span><span class="op">)</span></span></code></pre></div>
<p>Here is the dataset <code>dat</code>, along with our variables of
interest.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">sleepy</span>, <span class="va">Sleep</span>, <span class="va">PA</span>, <span class="va">SB</span>,</span>
<span>                          <span class="va">bilr1</span>, <span class="va">bilr2</span>, <span class="va">wilr1</span>, <span class="va">wilr2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">ID</th>
<th align="right">sleepy</th>
<th align="right">Sleep</th>
<th align="right">PA</th>
<th align="right">SB</th>
<th align="right">bilr1</th>
<th align="right">bilr2</th>
<th align="right">wilr1</th>
<th align="right">wilr2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">2.91</td>
<td align="right">437</td>
<td align="right">267.9</td>
<td align="right">735</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.478</td>
<td align="right">0.447</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1.02</td>
<td align="right">665</td>
<td align="right">116.2</td>
<td align="right">659</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">0.250</td>
<td align="right">-0.067</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1.89</td>
<td align="right">526</td>
<td align="right">209.8</td>
<td align="right">704</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.210</td>
<td align="right">0.304</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1.88</td>
<td align="right">611</td>
<td align="right">89.7</td>
<td align="right">739</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">0.240</td>
<td align="right">-0.331</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2.35</td>
<td align="right">488</td>
<td align="right">124.9</td>
<td align="right">827</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.125</td>
<td align="right">-0.177</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2.03</td>
<td align="right">382</td>
<td align="right">201.4</td>
<td align="right">856</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.534</td>
<td align="right">0.137</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="example-models">Example Models<a class="anchor" aria-label="anchor" href="#example-models"></a>
</h2>
<p>The model of interest is a multilevel model with 3-part composition
(Sleep, Physical Activity, Sedentary Behaviour), expressed as a 2 sets
of 2-part between and within-
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>l</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">ilr</annotation></semantics></math>
coordinates predicting sleepiness.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmcoda.html">brmcoda</a></span><span class="op">(</span><span class="va">cilr</span>, </span>
<span>               <span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>               cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               iter <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>               warmup <span class="op">=</span> <span class="fl">500</span>,</span>
<span>               seed <span class="op">=</span> <span class="fl">13</span>,</span>
<span>               backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>A summary of the model indicates that the bulk ESS values for the
constant and varying intercept as well as the constant coefficients of
the between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>l</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">ilr</annotation></semantics></math>
coordinates are low.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Family: gaussian </span></span>
<span><span class="co">#&gt;   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">#&gt; Formula: sleepy ~ bilr1 + bilr2 + wilr1 + wilr2 + (1 | ID) </span></span>
<span><span class="co">#&gt;    Data: tmp (Number of observations: 16800) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 3000; warmup = 500; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 10000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-Level Effects: </span></span>
<span><span class="co">#&gt; ~ID (Number of levels: 1200) </span></span>
<span><span class="co">#&gt;               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)     1.22      0.03     1.17     1.27 1.01      488      770</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept     2.35      0.15     2.04     2.65 1.02      286      640</span></span>
<span><span class="co">#&gt; bilr1         0.19      0.18    -0.18     0.52 1.01      312      520</span></span>
<span><span class="co">#&gt; bilr2         0.28      0.14    -0.00     0.56 1.02      280      532</span></span>
<span><span class="co">#&gt; wilr1        -0.80      0.03    -0.85    -0.74 1.00     9447     7579</span></span>
<span><span class="co">#&gt; wilr2        -0.26      0.02    -0.31    -0.22 1.00     9731     7932</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family Specific Parameters: </span></span>
<span><span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sigma     0.71      0.00     0.71     0.72 1.00    17695     7853</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<p>Further inspection of density and trace lots for these parameters
show some areas of the samples being drawn from outside of the parameter
space, but no strong evidence for non-convergence.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_Intercept"</span>, <span class="st">"b_bilr1"</span>, <span class="st">"b_bilr2"</span>, <span class="st">"sd_ID__Intercept"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="mlmcoda-plot-fit-1.png" alt="Density and Trace Plot of Parameters with Low ESS"><p class="caption">
Density and Trace Plot of Parameters with Low ESS
</p>
</div>
</div>
<div class="section level2">
<h2 id="improving-within-chain-autocorrelation-of-mcmc-sampling">Improving within-chain autocorrelation of MCMC sampling<a class="anchor" aria-label="anchor" href="#improving-within-chain-autocorrelation-of-mcmc-sampling"></a>
</h2>
<p>The low bulk ESS for random intercept model has been observed
previously, for example, see<br><a href="https://discourse.mc-stan.org/t/low-ess-and-high-rhat-for-random-intercept-slope-simulation-rstan-and-rstanarm/9985/6" class="external-link">here</a>
and <a href="https://discourse.mc-stan.org/t/low-bulk-ess-simple-random-intercept-model/23181/2" class="external-link">here</a>.
We explored two potential solution to improve MCMC sampling efficiency:
increasing posterior draws and reparameterisation.</p>
<div class="section level3">
<h3 id="increased-posterior-draws">Increased posterior draws<a class="anchor" aria-label="anchor" href="#increased-posterior-draws"></a>
</h3>
<p>As a first step, we test if increasing iterations and warmups
helps.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_it</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmcoda.html">brmcoda</a></span><span class="op">(</span><span class="va">cilr</span>, </span>
<span>                  <span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>                  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                  iter <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                  warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                  seed <span class="op">=</span> <span class="fl">13</span>,</span>
<span>                  backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-class.html" class="external-link">get_elapsed_time</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">Model</span><span class="op">$</span><span class="va">fit_it</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in object@mode: no applicable method for `@` applied to an object of class "NULL"</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_it</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Family: gaussian </span></span>
<span><span class="co">#&gt;   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">#&gt; Formula: sleepy ~ bilr1 + bilr2 + wilr1 + wilr2 + (1 | ID) </span></span>
<span><span class="co">#&gt;    Data: tmp (Number of observations: 16800) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 10000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 36000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-Level Effects: </span></span>
<span><span class="co">#&gt; ~ID (Number of levels: 1200) </span></span>
<span><span class="co">#&gt;               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)     1.22      0.03     1.17     1.27 1.00     1997     3971</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept     2.37      0.15     2.08     2.66 1.00     1130     2114</span></span>
<span><span class="co">#&gt; bilr1         0.18      0.18    -0.17     0.54 1.01      938     2477</span></span>
<span><span class="co">#&gt; bilr2         0.29      0.14     0.03     0.56 1.00     1182     2510</span></span>
<span><span class="co">#&gt; wilr1        -0.80      0.03    -0.85    -0.74 1.00    44344    28415</span></span>
<span><span class="co">#&gt; wilr2        -0.26      0.02    -0.31    -0.22 1.00    47155    29351</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family Specific Parameters: </span></span>
<span><span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sigma     0.71      0.00     0.71     0.72 1.00    62444    27585</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_it</span>, variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_Intercept"</span>, <span class="st">"b_bilr1"</span>, <span class="st">"b_bilr2"</span>, <span class="st">"sd_ID__Intercept"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="mlmcoda-plot-fit-it-1.png" alt="Density and Trace Plot after increasing iterations and warmups"><p class="caption">
Density and Trace Plot after increasing iterations and warmups
</p>
</div>
<p>It is a good sign that increasing interation and warmups increase the
ESS, supported by trace plots. The ratios of ESS of
<code>b_Intercept</code>, <code>b_bilr1</code>, <code>b_bilr2</code> and
<code>sd_ID_intercept</code> to <code>b_wilr1</code>,
<code>b_wilr2</code>, and <code>sigma</code> remain somewhat a
concern.</p>
</div>
<div class="section level3">
<h3 id="centered-parameterisation">Centered Parameterisation<a class="anchor" aria-label="anchor" href="#centered-parameterisation"></a>
</h3>
<p>By default, <code>brms</code> uses the non-centered parametrization.
However, <span class="citation">Betancourt and Girolami (2015)</span>
explains correlation depends on the amount of data, and the efficacy of
the parameterization depends on the relative strength of the data. For
small data sets, the computational implementation of the model using
non-parameterisation is more efficient. When there is enough data,
however, this parameterization is unnecessary and it may be more
efficient to use the centered parameterisation. Reparameterisation is
further discussed in <a href="https://betanalpha.github.io/assets/case_studies/hierarchical_modeling.html" class="external-link">Betancourt’s
case study</a> and <a href="https://vasishth.github.io/bayescogsci/book/ch-complexstan.html" class="external-link">Nicenboim,
Schad, and Vasishth’s chapter on complex models and
reparameterisation</a>.</p>
<p>Given that there is a small variation in our large simulated data
set, we are going to test if centered parameterisation improves the
sampling. We first obtain the Stan code for the example model</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/stancode.html" class="external-link">make_stancode</a></span><span class="op">(</span><span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; // generated with brms 2.19.0</span></span>
<span><span class="co">#&gt; functions {</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; data {</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; N;  // total number of observations</span></span>
<span><span class="co">#&gt;   vector[N] Y;  // response variable</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; K;  // number of population-level effects</span></span>
<span><span class="co">#&gt;   matrix[N, K] X;  // population-level design matrix</span></span>
<span><span class="co">#&gt;   // data for group-level effects of ID 1</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; N_1;  // number of grouping levels</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; M_1;  // number of coefficients per level</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; J_1[N];  // grouping indicator per observation</span></span>
<span><span class="co">#&gt;   // group-level predictor values</span></span>
<span><span class="co">#&gt;   vector[N] Z_1_1;</span></span>
<span><span class="co">#&gt;   int prior_only;  // should the likelihood be ignored?</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; transformed data {</span></span>
<span><span class="co">#&gt;   int Kc = K - 1;</span></span>
<span><span class="co">#&gt;   matrix[N, Kc] Xc;  // centered version of X without an intercept</span></span>
<span><span class="co">#&gt;   vector[Kc] means_X;  // column means of X before centering</span></span>
<span><span class="co">#&gt;   for (i in 2:K) {</span></span>
<span><span class="co">#&gt;     means_X[i - 1] = mean(X[, i]);</span></span>
<span><span class="co">#&gt;     Xc[, i - 1] = X[, i] - means_X[i - 1];</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; parameters {</span></span>
<span><span class="co">#&gt;   vector[Kc] b;  // population-level effects</span></span>
<span><span class="co">#&gt;   real Intercept;  // temporary intercept for centered predictors</span></span>
<span><span class="co">#&gt;   real&lt;lower=0&gt; sigma;  // dispersion parameter</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations</span></span>
<span><span class="co">#&gt;   vector[N_1] z_1[M_1];  // standardized group-level effects</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; transformed parameters {</span></span>
<span><span class="co">#&gt;   vector[N_1] r_1_1;  // actual group-level effects</span></span>
<span><span class="co">#&gt;   real lprior = 0;  // prior contributions to the log posterior</span></span>
<span><span class="co">#&gt;   r_1_1 = (sd_1[1] * (z_1[1]));</span></span>
<span><span class="co">#&gt;   lprior += student_t_lpdf(Intercept | 3, 2.1, 2.5);</span></span>
<span><span class="co">#&gt;   lprior += student_t_lpdf(sigma | 3, 0, 2.5)</span></span>
<span><span class="co">#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 2.5);</span></span>
<span><span class="co">#&gt;   lprior += student_t_lpdf(sd_1 | 3, 0, 2.5)</span></span>
<span><span class="co">#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 2.5);</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; model {</span></span>
<span><span class="co">#&gt;   // likelihood including constants</span></span>
<span><span class="co">#&gt;   if (!prior_only) {</span></span>
<span><span class="co">#&gt;     // initialize linear predictor term</span></span>
<span><span class="co">#&gt;     vector[N] mu = rep_vector(0.0, N);</span></span>
<span><span class="co">#&gt;     mu += Intercept;</span></span>
<span><span class="co">#&gt;     for (n in 1:N) {</span></span>
<span><span class="co">#&gt;       // add more terms to the linear predictor</span></span>
<span><span class="co">#&gt;       mu[n] += r_1_1[J_1[n]] * Z_1_1[n];</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     target += normal_id_glm_lpdf(Y | Xc, mu, b, sigma);</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt;   // priors including constants</span></span>
<span><span class="co">#&gt;   target += lprior;</span></span>
<span><span class="co">#&gt;   target += std_normal_lpdf(z_1[1]);</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; generated quantities {</span></span>
<span><span class="co">#&gt;   // actual population-level intercept</span></span>
<span><span class="co">#&gt;   real b_Intercept = Intercept - dot_product(means_X, b);</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>We then can manually edit the generated brms code to center all
parameters. The modified Stan code is</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m_centered</span> <span class="op">&lt;-</span> <span class="fu">cmdstan_model</span><span class="op">(</span><span class="st">"fit_centered.stan"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">m_centered</span><span class="op">)</span></span>
<span><span class="co">#&gt; data {</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; N;  // total number of observations</span></span>
<span><span class="co">#&gt;   vector[N] Y;  // response variable</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; K;  // number of population-level effects</span></span>
<span><span class="co">#&gt;   matrix[N, K] X;  // population-level design matrix</span></span>
<span><span class="co">#&gt;   // data for group-level effects of ID 1</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; N_1;  // number of grouping levels</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; M_1;  // number of coefficients per level</span></span>
<span><span class="co">#&gt;   int&lt;lower=1&gt; J_1[N];  // grouping indicator per observation</span></span>
<span><span class="co">#&gt;   // group-level predictor values</span></span>
<span><span class="co">#&gt;   vector[N] Z_1_1;</span></span>
<span><span class="co">#&gt;   int prior_only;  // should the likelihood be ignored?</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; transformed data {</span></span>
<span><span class="co">#&gt;   int Kc = K - 1;</span></span>
<span><span class="co">#&gt;   matrix[N, Kc] Xc;  // centered version of X without an intercept</span></span>
<span><span class="co">#&gt;   vector[Kc] means_X;  // column means of X before centering</span></span>
<span><span class="co">#&gt;   for (i in 2:K) {</span></span>
<span><span class="co">#&gt;     means_X[i - 1] = mean(X[, i]);</span></span>
<span><span class="co">#&gt;     Xc[, i - 1] = X[, i] - means_X[i - 1];</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; parameters {</span></span>
<span><span class="co">#&gt;   vector[Kc] b;  // population-level effects</span></span>
<span><span class="co">#&gt;   real Intercept;  // temporary intercept for centered predictors</span></span>
<span><span class="co">#&gt;   real&lt;lower=0&gt; sigma;  // dispersion parameter</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[M_1] sd_1;  // group-level standard deviations</span></span>
<span><span class="co">#&gt;   vector[N_1] z_1[M_1];  // standardized group-level effects</span></span>
<span><span class="co">#&gt;   </span></span>
<span><span class="co">#&gt;   // Manually added</span></span>
<span><span class="co">#&gt;    vector[N_1] r_1_1;  // actual group-level effects</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; //transformed parameters {</span></span>
<span><span class="co">#&gt; //  vector[N_1] r_1_1;  // actual group-level effects</span></span>
<span><span class="co">#&gt; //  real lprior = 0;  // prior contributions to the log posterior</span></span>
<span><span class="co">#&gt; //  r_1_1 = (sd_1[1] * (z_1[1]));</span></span>
<span><span class="co">#&gt; //  lprior += student_t_lpdf(Intercept | 3, 2, 2.5);</span></span>
<span><span class="co">#&gt; //  lprior += student_t_lpdf(sigma | 3, 0, 2.5)</span></span>
<span><span class="co">#&gt; //    - 1 * student_t_lccdf(0 | 3, 0, 2.5);</span></span>
<span><span class="co">#&gt; //  lprior += student_t_lpdf(sd_1 | 3, 0, 2.5)</span></span>
<span><span class="co">#&gt; //    - 1 * student_t_lccdf(0 | 3, 0, 2.5);</span></span>
<span><span class="co">#&gt; //}</span></span>
<span><span class="co">#&gt; model {</span></span>
<span><span class="co">#&gt;   // likelihood including constants</span></span>
<span><span class="co">#&gt;   if (!prior_only) {</span></span>
<span><span class="co">#&gt;     // initialize linear predictor term</span></span>
<span><span class="co">#&gt;     vector[N] mu = rep_vector(0.0, N);</span></span>
<span><span class="co">#&gt;     mu += Intercept;</span></span>
<span><span class="co">#&gt;     for (n in 1:N) {</span></span>
<span><span class="co">#&gt;       // add more terms to the linear predictor</span></span>
<span><span class="co">#&gt;       mu[n] += r_1_1[J_1[n]] * Z_1_1[n];</span></span>
<span><span class="co">#&gt;       </span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;     target += normal_id_glm_lpdf(Y | Xc, mu, b, sigma);</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt;   // priors including constants</span></span>
<span><span class="co">#&gt;   // target += lprior;</span></span>
<span><span class="co">#&gt;   // target += std_normal_lpdf(z_1[1]);</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   target += student_t_lpdf(Intercept | 3, 2, 2.5);</span></span>
<span><span class="co">#&gt;   target += student_t_lpdf(sigma | 3, 0, 2.5)</span></span>
<span><span class="co">#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 2.5);</span></span>
<span><span class="co">#&gt;   target += student_t_lpdf(sd_1 | 3, 0, 2.5)</span></span>
<span><span class="co">#&gt;     - 1 * student_t_lccdf(0 | 3, 0, 2.5);</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt;   // Manually added</span></span>
<span><span class="co">#&gt;   target += normal_lpdf(r_1_1 | 0, sd_1[1]);</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   // manual soft sum to zero constraint</span></span>
<span><span class="co">#&gt;   // target += normal_lpdf(sum(r_1_1) | 0, 0.0001 *N_1);</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; generated quantities {</span></span>
<span><span class="co">#&gt;   // actual population-level intercept</span></span>
<span><span class="co">#&gt;   real b_Intercept = Intercept - dot_product(means_X, b);</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>Now we build data for the model and sample with
<code>cmdstanr</code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/standata.html" class="external-link">make_standata</a></span><span class="op">(</span><span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">fit_centered</span> <span class="op">&lt;-</span> <span class="va">m_centered</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sdat</span>,</span>
<span>                                  parallel_chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  iter_sampling <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                                  iter_warmup <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bm_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span>, empty <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">bm_centered</span><span class="op">$</span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stan_csv.html" class="external-link">read_stan_csv</a></span><span class="op">(</span><span class="va">fit_centered</span><span class="op">$</span><span class="fu">output_files</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bm_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/rename_pars.html" class="external-link">rename_pars</a></span><span class="op">(</span><span class="va">bm_centered</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">bm_centered</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Family: gaussian </span></span>
<span><span class="co">#&gt;   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">#&gt; Formula: sleepy ~ bilr1 + bilr2 + wilr1 + wilr2 + (1 | ID) </span></span>
<span><span class="co">#&gt;    Data: dat (Number of observations: 16800) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 3000; warmup = 500; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 10000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-Level Effects: </span></span>
<span><span class="co">#&gt; ~ID (Number of levels: 1200) </span></span>
<span><span class="co">#&gt;               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)     1.22      0.03     1.17     1.27 1.00     9848     9674</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept     2.36      0.15     2.06     2.66 1.00    10497     5483</span></span>
<span><span class="co">#&gt; bilr1         0.19      0.18    -0.17     0.55 1.00    10539     5853</span></span>
<span><span class="co">#&gt; bilr2         0.29      0.14     0.01     0.56 1.00    10683     5784</span></span>
<span><span class="co">#&gt; wilr1        -0.80      0.03    -0.85    -0.74 1.00    10030     7217</span></span>
<span><span class="co">#&gt; wilr2        -0.26      0.02    -0.31    -0.22 1.00     9805     7335</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family Specific Parameters: </span></span>
<span><span class="co">#&gt;       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sigma     0.71      0.00     0.71     0.72 1.00     8197     6616</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<p>Indeed, the centered parameterisation has improved the ESS for all
parameters.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bm_centered</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_Intercept"</span>, <span class="st">"b_bilr1"</span>, <span class="st">"b_bilr2"</span>, <span class="st">"sd_ID__Intercept"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="mlmcoda-pair-fit-centered-1.png" alt="Density and Trace Plot when using centered parameterisation"><p class="caption">
Density and Trace Plot when using centered parameterisation
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="computational-time">Computational Time<a class="anchor" aria-label="anchor" href="#computational-time"></a>
</h2>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># example model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-class.html" class="external-link">get_elapsed_time</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">Model</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         warmup sample</span></span>
<span><span class="co">#&gt; chain:1   16.7   36.6</span></span>
<span><span class="co">#&gt; chain:2   14.6   36.6</span></span>
<span><span class="co">#&gt; chain:3   19.3   36.3</span></span>
<span><span class="co">#&gt; chain:4   15.4   36.7</span></span>
<span></span>
<span><span class="co"># increased iter</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-class.html" class="external-link">get_elapsed_time</a></span><span class="op">(</span><span class="va">fit_it</span><span class="op">$</span><span class="va">Model</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         warmup sample</span></span>
<span><span class="co">#&gt; chain:1   23.2    128</span></span>
<span><span class="co">#&gt; chain:2   20.9    129</span></span>
<span><span class="co">#&gt; chain:3   25.3    129</span></span>
<span><span class="co">#&gt; chain:4   21.8    129</span></span>
<span></span>
<span><span class="co"># centered parameterisation</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-class.html" class="external-link">get_elapsed_time</a></span><span class="op">(</span><span class="va">bm_centered</span><span class="op">$</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;         warmup sample</span></span>
<span><span class="co">#&gt; chain:1    200   1125</span></span>
<span><span class="co">#&gt; chain:2    199   1121</span></span>
<span><span class="co">#&gt; chain:3    202   1121</span></span>
<span><span class="co">#&gt; chain:4    200   1124</span></span></code></pre></div>
<p>It took 607.051 to obtain an average-ish of 1000 across the four
parameters with initially low ESS. To achieve an ESS of 10 000 across
all parameters, simplying increasing iterations should take around
6070.51, whereas centered parameterisation takes around 5292.319.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><code>multilevelcoda</code> demonstrates excellent performances
across different conditions of number of individuals, number of
observations, number of compositional parts, and magnitude of modeled
variance (full results of simulation study will be published at a later
date). However, in the case of large data and small sample variation, we
recommend centered parameterisation or increasing iterations to achieve
efficient MCMC sampling. Based on results of the case study, centered
parameterisation would give more reliable results in terms of
ESS-to-draw ratios for all parameters and computational time.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-betancourt2015" class="csl-entry">
Betancourt, Michael, and Mark Girolami. 2015. <span>“Hamiltonian Monte
Carlo for Hierarchical Models.”</span> <em>Current Trends in Bayesian
Methodology with Applications</em> 79 (30): 2–4.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/florale" class="external-link">Flora Le</a>, Joshua F. Wiley.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
  <p class="preferably">Using <a href="https://preferably.amirmasoudabdol.name/?source=footer" class="external-link">preferably</a> template.</p>
</div>

    </footer>
</div>





  </body>
</html>
