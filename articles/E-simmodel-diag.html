<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="multilevelcoda">
<!-- Inform modern browsers that this page supports both dark and light color schemes,
  and the page author prefers light. --><meta name="color-scheme" content="dark light">
<script>
  // If `prefers-color-scheme` is not supported, fall back to light mode.
  // i.e. In this case, inject the `light` CSS before the others, with
  // no media filter so that it will be downloaded with highest priority.
  if (window.matchMedia("(prefers-color-scheme: dark)").media === "not all") {
    document.documentElement.style.display = "none";
    document.head.insertAdjacentHTML(
      "beforeend",
      "<link id=\"css\" rel=\"stylesheet\" href=\"https://bootswatch.com/5/flatly/bootstrap.css\" onload=\"document.documentElement.style.display = ''\">"
    );
  }
</script><title>Improving MCMC Sampling for Bayesian Compositional Multilevel Models • multilevelcoda</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Improving MCMC Sampling for Bayesian Compositional Multilevel Models">
<meta property="og:description" content="multilevelcoda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Flatly Theme - Light  --><link id="css-light" rel="stylesheet" href="https://bootswatch.com/5/flatly/bootstrap.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<!-- Darkly Theme - Dark --><link id="css-dark" rel="stylesheet" href="https://bootswatch.com/5/darkly/bootstrap.css" media="(prefers-color-scheme: dark)">
<!-- preferably CSS --><link rel="stylesheet" href="../preferably.css">
<link id="css-code-light" rel="stylesheet" href="../code-color-scheme-light.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
<link id="css-code-dark" rel="stylesheet" href="../code-color-scheme-dark.css" media="(prefers-color-scheme: dark)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">multilevelcoda</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-2">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/A-introduction.html">Introduction to Compositional Multilevel Modelling</a>
    <a class="dropdown-item" href="../articles/B-composition-MLM.html">Multilevel Models with Compositional Predictors</a>
    <a class="dropdown-item" href="../articles/C-composition-MMLM.html">Multilevel Model with Compositional Outcomes</a>
    <a class="dropdown-item" href="../articles/D-substitution-model.html">Compositional Multilevel Substitution Models</a>
    <a class="dropdown-item" href="../articles/E-simmodel-diag.html">Improving MCMC Sampling for Bayesian Compositional Multilevel Models</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/florale/multilevelcoda/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>

        
        
        
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Improving MCMC Sampling for Bayesian Compositional Multilevel Models</h1>
                        <h4 data-toc-skip class="author">Flora Le</h4>
            
            <h4 data-toc-skip class="date">2023-08-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/florale/multilevelcoda/blob/HEAD/vignettes/E-simmodel-diag.Rmd" class="external-link"><code>vignettes/E-simmodel-diag.Rmd</code></a></small>
      <div class="d-none name"><code>E-simmodel-diag.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignettes, we present a case study we encountered in the
simulation study for package <code>multilevelcoda</code>. Briefly, we
found that multilevel model with compositional predictors with large
sample size, large between-person heterogeneity and small within-person
heterogeneity (large <span class="math inline">\(\sigma^2_{u}\)</span>
and small <span class="math inline">\(\sigma^2_{\varepsilon}\)</span>)
produced low bulk effective sample size (ESS). Here, we examined the
diagnostics of the model of interest and explored different methods to
improve the within-chain autocorrelation.</p>
</div>
<div class="section level2">
<h2 id="generating-data-from-simulation-study">Generating Data from Simulation Study<a class="anchor" aria-label="anchor" href="#generating-data-from-simulation-study"></a>
</h2>
<p>We first generated a dataset consisting of a 3-part behaviour
composition with 1200 individuals, 14 observations per individuals, and
large random intercept variation (<span class="math inline">\(\sigma^2_{u} = 1.5\)</span>), coupled with small
residual variation (<span class="math inline">\(\sigma^2_{\varepsilon}:
0.5\)</span>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">sampled_cond</span> <span class="op">&lt;-</span> <span class="va">cond</span><span class="op">[</span><span class="va">condition</span> <span class="op">==</span> <span class="st">"RElarge_RESsmall"</span> <span class="op">&amp;</span> <span class="va">n_parts</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">&amp;</span> <span class="va">N</span> <span class="op">==</span> <span class="fl">1200</span> <span class="op">&amp;</span> <span class="va">K</span> <span class="op">==</span> <span class="fl">14</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># condition</span></span>
<span><span class="va">N</span>             <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">N</span><span class="op">]</span></span>
<span><span class="va">K</span>             <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">K</span><span class="op">]</span></span>
<span><span class="va">rint_sd</span>       <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">rint_sd</span><span class="op">]</span></span>
<span><span class="va">res_sd</span>        <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">res_sd</span><span class="op">]</span></span>
<span><span class="va">run</span>           <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">run</span><span class="op">]</span></span>
<span><span class="va">n_parts</span>       <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">n_parts</span><span class="op">]</span></span>
<span><span class="va">sbp_n</span>         <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">sbp</span><span class="op">]</span></span>
<span><span class="va">prefit_n</span>      <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">prefit</span><span class="op">]</span></span>
<span><span class="va">groundtruth_n</span> <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">groundtruth</span><span class="op">]</span></span>
<span><span class="va">parts</span>         <span class="op">&lt;-</span> <span class="va">sampled_cond</span><span class="op">[</span><span class="va">i</span>, <span class="va">parts</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># inputs</span></span>
<span><span class="va">sbp</span>           <span class="op">&lt;-</span> <span class="va">meanscovs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">sbp_n</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">prefit</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">prefit_n</span><span class="op">)</span></span>
<span><span class="va">groundtruth</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">groundtruth_n</span><span class="op">)</span></span>
<span><span class="va">parts</span>         <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">parts</span>, <span class="st">" "</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">meanscovs</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">simulateData</span><span class="op">(</span></span>
<span>    bm <span class="op">=</span> <span class="va">BMeans</span>,</span>
<span>    wm <span class="op">=</span> <span class="va">WMeans</span>,</span>
<span>    bcov <span class="op">=</span> <span class="va">BCov</span>,</span>
<span>    wcov <span class="op">=</span> <span class="va">WCov</span>,</span>
<span>    n <span class="op">=</span> <span class="va">N</span>,</span>
<span>    k <span class="op">=</span> <span class="va">K</span>,</span>
<span>    psi <span class="op">=</span> <span class="va">psi</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simd</span><span class="op">[</span>, <span class="va">Sleep</span> <span class="op">:=</span> <span class="va">TST</span> <span class="op">+</span> <span class="va">WAKE</span><span class="op">]</span></span>
<span><span class="va">simd</span><span class="op">[</span>, <span class="va">PA</span> <span class="op">:=</span> <span class="va">MVPA</span> <span class="op">+</span> <span class="va">LPA</span><span class="op">]</span></span>
<span><span class="co"># ILR ---------------------------------------------------</span></span>
<span><span class="va">cilr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compilr.html">compilr</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">simd</span>,</span>
<span>  sbp <span class="op">=</span> <span class="va">sbp</span>,</span>
<span>  parts <span class="op">=</span> <span class="va">parts</span>,</span>
<span>  idvar <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cilr</span><span class="op">$</span><span class="va">data</span>,</span>
<span>             <span class="va">cilr</span><span class="op">$</span><span class="va">BetweenILR</span>,</span>
<span>             <span class="va">cilr</span><span class="op">$</span><span class="va">WithinILR</span>,</span>
<span>             <span class="va">cilr</span><span class="op">$</span><span class="va">TotalILR</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># random effects ----------------------------------------</span></span>
<span><span class="va">redat</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="op">(</span>ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span>,</span>
<span>                    rint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>                      n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      mean <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                      sd <span class="op">=</span> <span class="va">rint_sd</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="va">redat</span>, by <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># outcome -----------------------------------------------</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">n_parts</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">tmp</span><span class="op">[</span>, <span class="va">sleepy</span> <span class="op">:=</span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">simd</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="va">groundtruth</span><span class="op">$</span><span class="va">b_Intercept</span>  <span class="op">+</span> <span class="va">rint</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_bilr1</span> <span class="op">*</span> <span class="va">bilr1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_bilr2</span> <span class="op">*</span> <span class="va">bilr2</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_wilr1</span> <span class="op">*</span> <span class="va">wilr1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">groundtruth</span><span class="op">$</span><span class="va">b_wilr2</span> <span class="op">*</span> <span class="va">wilr2</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="va">res_sd</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span>           </span>
<span><span class="va">simd</span><span class="op">$</span><span class="va">sleepy</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">sleepy</span></span>
<span></span>
<span><span class="va">cilr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compilr.html">compilr</a></span><span class="op">(</span><span class="va">simd</span>, <span class="va">sbp</span>, <span class="va">parts</span>, total <span class="op">=</span> <span class="fl">1440</span>, idvar <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cilr</span><span class="op">$</span><span class="va">data</span>, <span class="va">cilr</span><span class="op">$</span><span class="va">BetweenILR</span>, <span class="va">cilr</span><span class="op">$</span><span class="va">WithinILR</span><span class="op">)</span></span></code></pre></div>
<p>Here is the dataset <code>dat</code>, along with our variables of
interest.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">ID</span>, <span class="va">sleepy</span>, <span class="va">Sleep</span>, <span class="va">PA</span>, <span class="va">SB</span>,</span>
<span>                          <span class="va">bilr1</span>, <span class="va">bilr2</span>, <span class="va">wilr1</span>, <span class="va">wilr2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">ID</th>
<th align="right">sleepy</th>
<th align="right">Sleep</th>
<th align="right">PA</th>
<th align="right">SB</th>
<th align="right">bilr1</th>
<th align="right">bilr2</th>
<th align="right">wilr1</th>
<th align="right">wilr2</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">2.91</td>
<td align="right">437</td>
<td align="right">267.9</td>
<td align="right">735</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.478</td>
<td align="right">0.447</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1.02</td>
<td align="right">665</td>
<td align="right">116.2</td>
<td align="right">659</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">0.250</td>
<td align="right">-0.067</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1.89</td>
<td align="right">526</td>
<td align="right">209.8</td>
<td align="right">704</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.210</td>
<td align="right">0.304</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">1.88</td>
<td align="right">611</td>
<td align="right">89.7</td>
<td align="right">739</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">0.240</td>
<td align="right">-0.331</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">2.35</td>
<td align="right">488</td>
<td align="right">124.9</td>
<td align="right">827</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.125</td>
<td align="right">-0.177</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2.03</td>
<td align="right">382</td>
<td align="right">201.4</td>
<td align="right">856</td>
<td align="right">0.466</td>
<td align="right">-1.16</td>
<td align="right">-0.534</td>
<td align="right">0.137</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="example-models">Example Models<a class="anchor" aria-label="anchor" href="#example-models"></a>
</h2>
<p>The model of interest is a multilevel model with 3-part composition
(Sleep, Physical Activity, Sedentary Behaviour), expressed as a 2 sets
of 2-part between and within- <span class="math inline">\(ilr\)</span>
coordinates predicting sleepiness.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmcoda.html">brmcoda</a></span><span class="op">(</span><span class="va">cilr</span>, </span>
<span>               <span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>               cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               iter <span class="op">=</span> <span class="fl">3000</span>,</span>
<span>               warmup <span class="op">=</span> <span class="fl">500</span>,</span>
<span>               backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>A summary of the model indicates that the bulk ESS values for the
constant and varying intercept as well as the constant coefficients of
the between <span class="math inline">\(ilr\)</span> coordinates are
low.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   Family<span class="sc">:</span> gaussian </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    Links<span class="sc">:</span> mu <span class="ot">=</span> identity; sigma <span class="ot">=</span> identity </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  Formula<span class="sc">:</span> sleepy <span class="sc">~</span> bilr1 <span class="sc">+</span> bilr2 <span class="sc">+</span> wilr1 <span class="sc">+</span> wilr2 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> ID) </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>     Data<span class="sc">:</span> <span class="fu">tmp</span> (Number of observations<span class="sc">:</span> <span class="dv">16800</span>) </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    Draws<span class="sc">:</span> <span class="dv">4</span> chains, each with iter <span class="ot">=</span> <span class="dv">3000</span>; warmup <span class="ot">=</span> <span class="dv">500</span>; thin <span class="ot">=</span> <span class="dv">1</span>;</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>           total post<span class="sc">-</span>warmup draws <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  Group<span class="sc">-</span>Level Effects<span class="sc">:</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">~</span><span class="fu">ID</span> (Number of levels<span class="sc">:</span> <span class="dv">1200</span>) </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sd</span>(Intercept)     <span class="fl">1.22</span>      <span class="fl">0.03</span>     <span class="fl">1.17</span>     <span class="fl">1.27</span> <span class="fl">1.02</span>      <span class="dv">572</span>      <span class="dv">934</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  Population<span class="sc">-</span>Level Effects<span class="sc">:</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  Intercept     <span class="fl">2.36</span>      <span class="fl">0.15</span>     <span class="fl">2.06</span>     <span class="fl">2.65</span> <span class="fl">1.01</span>      <span class="dv">326</span>      <span class="dv">617</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  bilr1         <span class="fl">0.20</span>      <span class="fl">0.19</span>    <span class="sc">-</span><span class="fl">0.17</span>     <span class="fl">0.57</span> <span class="fl">1.01</span>      <span class="dv">224</span>      <span class="dv">463</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  bilr2         <span class="fl">0.29</span>      <span class="fl">0.14</span>     <span class="fl">0.01</span>     <span class="fl">0.56</span> <span class="fl">1.01</span>      <span class="dv">325</span>      <span class="dv">607</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  wilr1        <span class="sc">-</span><span class="fl">0.80</span>      <span class="fl">0.03</span>    <span class="sc">-</span><span class="fl">0.85</span>    <span class="sc">-</span><span class="fl">0.74</span> <span class="fl">1.00</span>    <span class="dv">10829</span>     <span class="dv">7772</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  wilr2        <span class="sc">-</span><span class="fl">0.26</span>      <span class="fl">0.02</span>    <span class="sc">-</span><span class="fl">0.31</span>    <span class="sc">-</span><span class="fl">0.22</span> <span class="fl">1.00</span>    <span class="dv">11257</span>     <span class="dv">8102</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  Family Specific Parameters<span class="sc">:</span> </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  sigma     <span class="fl">0.71</span>      <span class="fl">0.00</span>     <span class="fl">0.71</span>     <span class="fl">0.72</span> <span class="fl">1.00</span>    <span class="dv">19111</span>     <span class="dv">8010</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  Draws were sampled using <span class="fu">sample</span>(hmc). For each parameter, Bulk_ESS</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  scale reduction factor on split <span class="fu">chains</span> (at convergence, <span class="at">Rhat =</span> <span class="dv">1</span>).</span></code></pre></div>
<p>Further inspection of density and trace lots for these parameters
show some areas of the samples being drawn from outside of the parameter
space, but no strong evidence for non-convergence.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit</span>, variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_Intercept"</span>, <span class="st">"b_bilr1"</span>, <span class="st">"b_bilr2"</span>, <span class="st">"sd_ID__Intercept"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="mlmcoda-plot-fit-1.png" alt="plot of chunk plot-fit"><p class="caption">
plot of chunk plot-fit
</p>
</div>
</div>
<div class="section level2">
<h2 id="improving-within-chain-autocorrelation-of-mcmc-sampling">Improving within-chain autocorrelation of MCMC sampling<a class="anchor" aria-label="anchor" href="#improving-within-chain-autocorrelation-of-mcmc-sampling"></a>
</h2>
<p>The low bulk ESS for random intercept model has been observed
previously, for example, see<br><a href="https://discourse.mc-stan.org/t/low-ess-and-high-rhat-for-random-intercept-slope-simulation-rstan-and-rstanarm/9985/6" class="external-link">here</a>
and <a href="https://discourse.mc-stan.org/t/low-bulk-ess-simple-random-intercept-model/23181/2" class="external-link">here</a>.
We explored two potential solution to improve MCMC sampling efficiency:
increasing posterior draws and reparameterisation.</p>
<div class="section level3">
<h3 id="increased-posterior-draws">Increased posterior draws<a class="anchor" aria-label="anchor" href="#increased-posterior-draws"></a>
</h3>
<p>As a first step, we test if increasing iterations and warmups
help.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_it</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brmcoda.html">brmcoda</a></span><span class="op">(</span><span class="va">cilr</span>, </span>
<span>                  <span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>,</span>
<span>                  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                  chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                  iter <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                  warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                  backend <span class="op">=</span> <span class="st">"cmdstanr"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(fit_it)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>   Family<span class="sc">:</span> gaussian </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    Links<span class="sc">:</span> mu <span class="ot">=</span> identity; sigma <span class="ot">=</span> identity </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  Formula<span class="sc">:</span> sleepy <span class="sc">~</span> bilr1 <span class="sc">+</span> bilr2 <span class="sc">+</span> wilr1 <span class="sc">+</span> wilr2 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> ID) </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>     Data<span class="sc">:</span> <span class="fu">tmp</span> (Number of observations<span class="sc">:</span> <span class="dv">16800</span>) </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    Draws<span class="sc">:</span> <span class="dv">4</span> chains, each with iter <span class="ot">=</span> <span class="dv">10000</span>; warmup <span class="ot">=</span> <span class="dv">1000</span>; thin <span class="ot">=</span> <span class="dv">1</span>;</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>           total post<span class="sc">-</span>warmup draws <span class="ot">=</span> <span class="dv">36000</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  Group<span class="sc">-</span>Level Effects<span class="sc">:</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">~</span><span class="fu">ID</span> (Number of levels<span class="sc">:</span> <span class="dv">1200</span>) </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sd</span>(Intercept)     <span class="fl">1.22</span>      <span class="fl">0.03</span>     <span class="fl">1.17</span>     <span class="fl">1.27</span> <span class="fl">1.00</span>     <span class="dv">1612</span>     <span class="dv">3586</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  Population<span class="sc">-</span>Level Effects<span class="sc">:</span> </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  Intercept     <span class="fl">2.36</span>      <span class="fl">0.15</span>     <span class="fl">2.07</span>     <span class="fl">2.65</span> <span class="fl">1.01</span>      <span class="dv">750</span>     <span class="dv">1969</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  bilr1         <span class="fl">0.19</span>      <span class="fl">0.18</span>    <span class="sc">-</span><span class="fl">0.16</span>     <span class="fl">0.54</span> <span class="fl">1.00</span>      <span class="dv">853</span>     <span class="dv">2073</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  bilr2         <span class="fl">0.29</span>      <span class="fl">0.14</span>     <span class="fl">0.01</span>     <span class="fl">0.57</span> <span class="fl">1.01</span>      <span class="dv">784</span>     <span class="dv">1771</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  wilr1        <span class="sc">-</span><span class="fl">0.80</span>      <span class="fl">0.03</span>    <span class="sc">-</span><span class="fl">0.85</span>    <span class="sc">-</span><span class="fl">0.74</span> <span class="fl">1.00</span>    <span class="dv">34233</span>    <span class="dv">28657</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  wilr2        <span class="sc">-</span><span class="fl">0.26</span>      <span class="fl">0.02</span>    <span class="sc">-</span><span class="fl">0.31</span>    <span class="sc">-</span><span class="fl">0.22</span> <span class="fl">1.00</span>    <span class="dv">35412</span>    <span class="dv">28327</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  Family Specific Parameters<span class="sc">:</span> </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  sigma     <span class="fl">0.71</span>      <span class="fl">0.00</span>     <span class="fl">0.71</span>     <span class="fl">0.72</span> <span class="fl">1.00</span>    <span class="dv">52322</span>    <span class="dv">29158</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  Draws were sampled using <span class="fu">sample</span>(hmc). For each parameter, Bulk_ESS</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  scale reduction factor on split <span class="fu">chains</span> (at convergence, <span class="at">Rhat =</span> <span class="dv">1</span>).</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_it</span>, variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_Intercept"</span>, <span class="st">"b_bilr1"</span>, <span class="st">"b_bilr2"</span>, <span class="st">"sd_ID__Intercept"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="mlmcoda-plot-fit-it-1.png" alt="plot of chunk plot-fit-it"><p class="caption">
plot of chunk plot-fit-it
</p>
</div>
<p>It is a good sign that increasing interation and warmups increase the
ESS, supported by trace plots. The ratios of ESS of
<code>b_Intercept</code>, <code>b_bilr1</code>, <code>b_bilr2</code> and
<code>sd_ID_intercept</code> to <code>b_wilr1</code>,
<code>b_wilr2</code>, and <code>sigma</code> remain somewhat a
concern.</p>
</div>
<div class="section level3">
<h3 id="centered-parameterisation">Centered Parameterisation<a class="anchor" aria-label="anchor" href="#centered-parameterisation"></a>
</h3>
<p>By default, <code>brms</code> uses the non-centered parametrization.
However, <span class="citation">Betancourt and Girolami (2015)</span>
explains correlation depends on the amount of data, and the efficacy of
the parameterization depends on the relative strength of the data. For
small data sets, the computational implementation of the model using
non-parameterisation is more efficient. When there is enough data,
however, this parameterization is unnecessary and it may be more
efficient to use the centered parameterisation. Reparameterisation is
further discussed in <a href="https://betanalpha.github.io/assets/case_studies/hierarchical_modeling.html" class="external-link">Betancourt’s
case study</a> and <a href="https://vasishth.github.io/bayescogsci/book/ch-complexstan.html" class="external-link">Nicenboim,
Schad, and Vasishth’s chapter on complex models and
reparameterisation</a>.</p>
<p>Given that there is a small variation in our large simulated data
set, we are going to test if centered parameterisation improves the
sampling. We first obtain the Stan code for the example model</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make_stancode</span>(sleepy <span class="sc">~</span> bilr1 <span class="sc">+</span> bilr2 <span class="sc">+</span> wilr1 <span class="sc">+</span> wilr2 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> ID), <span class="at">data =</span> dat)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">/</span><span class="er">/</span> generated with brms <span class="dv">2</span>.<span class="fl">19.0</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  functions {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  data {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> N;  <span class="sc">/</span><span class="er">/</span> total number of observations</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    vector[N] Y;  <span class="sc">/</span><span class="er">/</span> response variable</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> K;  <span class="sc">/</span><span class="er">/</span> number of population<span class="sc">-</span>level effects</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    matrix[N, K] X;  <span class="sc">/</span><span class="er">/</span> population<span class="sc">-</span>level design matrix</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span> data <span class="cf">for</span> group<span class="sc">-</span>level effects of ID <span class="dv">1</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> N_1;  <span class="sc">/</span><span class="er">/</span> number of grouping levels</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> M_1;  <span class="sc">/</span><span class="er">/</span> number of coefficients per level</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    int<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">1</span><span class="sc">&gt;</span> J_1[N];  <span class="sc">/</span><span class="er">/</span> grouping indicator per observation</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span> group<span class="sc">-</span>level predictor values</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    vector[N] Z_1_1;</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    int prior_only;  <span class="sc">/</span><span class="er">/</span> should the likelihood be ignored?</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  transformed data {</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    int Kc <span class="ot">=</span> K <span class="sc">-</span> <span class="dv">1</span>;</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    matrix[N, Kc] Xc;  <span class="sc">/</span><span class="er">/</span> centered version of X without an intercept</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    vector[Kc] means_X;  <span class="sc">/</span><span class="er">/</span> column means of X before centering</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>K) {</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>      means_X[i <span class="sc">-</span> <span class="dv">1</span>] <span class="ot">=</span> <span class="fu">mean</span>(X[, i]);</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>      Xc[, i <span class="sc">-</span> <span class="dv">1</span>] <span class="ot">=</span> X[, i] <span class="sc">-</span> means_X[i <span class="sc">-</span> <span class="dv">1</span>];</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  parameters {</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    vector[Kc] b;  <span class="sc">/</span><span class="er">/</span> population<span class="sc">-</span>level effects</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    real Intercept;  <span class="sc">/</span><span class="er">/</span> temporary intercept <span class="cf">for</span> centered predictors</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    real<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span> sigma;  <span class="sc">/</span><span class="er">/</span> dispersion parameter</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    vector<span class="sc">&lt;</span>lower<span class="ot">=</span><span class="dv">0</span><span class="sc">&gt;</span>[M_1] sd_1;  <span class="sc">/</span><span class="er">/</span> group<span class="sc">-</span>level standard deviations</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    vector[N_1] z_1[M_1];  <span class="sc">/</span><span class="er">/</span> standardized group<span class="sc">-</span>level effects</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  transformed parameters {</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    vector[N_1] r_1_1;  <span class="sc">/</span><span class="er">/</span> actual group<span class="sc">-</span>level effects</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    real lprior <span class="ot">=</span> <span class="dv">0</span>;  <span class="sc">/</span><span class="er">/</span> prior contributions to the log posterior</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    r_1_1 <span class="ot">=</span> (sd_1[<span class="dv">1</span>] <span class="sc">*</span> (z_1[<span class="dv">1</span>]));</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(Intercept <span class="sc">|</span> <span class="dv">3</span>, <span class="fl">2.1</span>, <span class="fl">2.5</span>);</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(sigma <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> <span class="dv">1</span> <span class="sc">*</span> <span class="fu">student_t_lccdf</span>(<span class="dv">0</span> <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    lprior <span class="sc">+</span><span class="er">=</span> <span class="fu">student_t_lpdf</span>(sd_1 <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> <span class="dv">1</span> <span class="sc">*</span> <span class="fu">student_t_lccdf</span>(<span class="dv">0</span> <span class="sc">|</span> <span class="dv">3</span>, <span class="dv">0</span>, <span class="fl">2.5</span>);</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  model {</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span> likelihood including constants</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>prior_only) {</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>      <span class="sc">/</span><span class="er">/</span> initialize linear predictor term</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      vector[N] mu <span class="ot">=</span> <span class="fu">rep_vector</span>(<span class="fl">0.0</span>, N);</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>      mu <span class="sc">+</span><span class="er">=</span> Intercept;</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        <span class="sc">/</span><span class="er">/</span> add more terms to the linear predictor</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        mu[n] <span class="sc">+</span><span class="er">=</span> r_1_1[J_1[n]] <span class="sc">*</span> Z_1_1[n];</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>      target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_id_glm_lpdf</span>(Y <span class="sc">|</span> Xc, mu, b, sigma);</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span> priors including constants</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    target <span class="sc">+</span><span class="er">=</span> lprior;</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    target <span class="sc">+</span><span class="er">=</span> <span class="fu">std_normal_lpdf</span>(z_1[<span class="dv">1</span>]);</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  generated quantities {</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    <span class="sc">/</span><span class="er">/</span> actual population<span class="sc">-</span>level intercept</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    real b_Intercept <span class="ot">=</span> Intercept <span class="sc">-</span> <span class="fu">dot_product</span>(means_X, b);</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>We then can manually edit the generated brms code to center all
parameters. The modified Stan code is</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m_centered</span> <span class="op">&lt;-</span> <span class="fu">cmdstan_model</span><span class="op">(</span><span class="st">"fit_centered.stan"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">m_centered</span><span class="op">)</span></span></code></pre></div>
<p>Now we build data for the model and sample with
<code>cmdstanr</code></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/make_standata.html" class="external-link">make_standata</a></span><span class="op">(</span><span class="va">sleepy</span> <span class="op">~</span> <span class="va">bilr1</span> <span class="op">+</span> <span class="va">bilr2</span> <span class="op">+</span> <span class="va">wilr1</span> <span class="op">+</span> <span class="va">wilr2</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">fit_centered</span> <span class="op">&lt;-</span> <span class="va">m_centered</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span>data <span class="op">=</span> <span class="va">sdat</span>,</span>
<span>                                  parallel_chains <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  iter_sampling <span class="op">=</span> <span class="fl">2500</span>,</span>
<span>                                  iter_warmup <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>bm_centered <span class="ot">&lt;-</span> <span class="fu">brm</span>(sleepy <span class="sc">~</span> bilr1 <span class="sc">+</span> bilr2 <span class="sc">+</span> wilr1 <span class="sc">+</span> wilr2 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> ID), <span class="at">data =</span> dat, <span class="at">empty =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>bm_centered<span class="sc">$</span>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">read_stan_csv</span>(fit_centered<span class="sc">$</span><span class="fu">output_files</span>())</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>bm_centered <span class="ot">&lt;-</span> <span class="fu">rename_pars</span>(bm_centered)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bm_centered)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>   Family<span class="sc">:</span> gaussian </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    Links<span class="sc">:</span> mu <span class="ot">=</span> identity; sigma <span class="ot">=</span> identity </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  Formula<span class="sc">:</span> sleepy <span class="sc">~</span> bilr1 <span class="sc">+</span> bilr2 <span class="sc">+</span> wilr1 <span class="sc">+</span> wilr2 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> ID) </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>     Data<span class="sc">:</span> <span class="fu">dat</span> (Number of observations<span class="sc">:</span> <span class="dv">16800</span>) </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    Draws<span class="sc">:</span> <span class="dv">4</span> chains, each with iter <span class="ot">=</span> <span class="dv">3000</span>; warmup <span class="ot">=</span> <span class="dv">500</span>; thin <span class="ot">=</span> <span class="dv">1</span>;</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>           total post<span class="sc">-</span>warmup draws <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  Group<span class="sc">-</span>Level Effects<span class="sc">:</span> </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="er">~</span><span class="fu">ID</span> (Number of levels<span class="sc">:</span> <span class="dv">1200</span>) </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sd</span>(Intercept)     <span class="fl">1.22</span>      <span class="fl">0.03</span>     <span class="fl">1.17</span>     <span class="fl">1.27</span> <span class="fl">1.00</span>     <span class="dv">9848</span>     <span class="dv">9674</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  Population<span class="sc">-</span>Level Effects<span class="sc">:</span> </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  Intercept     <span class="fl">2.36</span>      <span class="fl">0.15</span>     <span class="fl">2.06</span>     <span class="fl">2.66</span> <span class="fl">1.00</span>    <span class="dv">10497</span>     <span class="dv">5483</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  bilr1         <span class="fl">0.19</span>      <span class="fl">0.18</span>    <span class="sc">-</span><span class="fl">0.17</span>     <span class="fl">0.55</span> <span class="fl">1.00</span>    <span class="dv">10539</span>     <span class="dv">5853</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  bilr2         <span class="fl">0.29</span>      <span class="fl">0.14</span>     <span class="fl">0.01</span>     <span class="fl">0.56</span> <span class="fl">1.00</span>    <span class="dv">10683</span>     <span class="dv">5784</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  wilr1        <span class="sc">-</span><span class="fl">0.80</span>      <span class="fl">0.03</span>    <span class="sc">-</span><span class="fl">0.85</span>    <span class="sc">-</span><span class="fl">0.74</span> <span class="fl">1.00</span>    <span class="dv">10030</span>     <span class="dv">7217</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  wilr2        <span class="sc">-</span><span class="fl">0.26</span>      <span class="fl">0.02</span>    <span class="sc">-</span><span class="fl">0.31</span>    <span class="sc">-</span><span class="fl">0.22</span> <span class="fl">1.00</span>     <span class="dv">9805</span>     <span class="dv">7335</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  Family Specific Parameters<span class="sc">:</span> </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        Estimate Est.Error l<span class="dv">-95</span><span class="sc">% CI u-95%</span> CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  sigma     <span class="fl">0.71</span>      <span class="fl">0.00</span>     <span class="fl">0.71</span>     <span class="fl">0.72</span> <span class="fl">1.00</span>     <span class="dv">8197</span>     <span class="dv">6616</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  Draws were sampled using <span class="fu">sample</span>(hmc). For each parameter, Bulk_ESS</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  scale reduction factor on split <span class="fu">chains</span> (at convergence, <span class="at">Rhat =</span> <span class="dv">1</span>).</span></code></pre></div>
<p>Indeed, the centered parameterisation has improved the ESS for all
parameters.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bm_centered</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"b_Intercept"</span>, <span class="st">"b_bilr1"</span>, <span class="st">"b_bilr2"</span>, <span class="st">"sd_ID__Intercept"</span><span class="op">)</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="mlmcoda-pair-fit-centered-1.png" alt="plot of chunk pair-fit-centered"><p class="caption">
plot of chunk pair-fit-centered
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><code>multilevelcoda</code> demonstrates excellent performances
across different conditions of number of individuals, number of
observations, number of compositional parts, and magnitude of modeled
variance (read more about our simulation study at) However, in the case
of large data and small sample variation, we recommend centered
parameterisation or increase in iterations to achieve efficient MCMC
sampling and acceptable ESS.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-betancourt2015" class="csl-entry">
Betancourt, Michael, and Mark Girolami. 2015. <span>“Hamiltonian Monte
Carlo for Hierarchical Models.”</span> <em>Current Trends in Bayesian
Methodology with Applications</em> 79 (30): 2–4.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/florale" class="external-link">Flora Le</a>, Joshua F. Wiley.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
  <p class="preferably">Using <a href="https://preferably.amirmasoudabdol.name/?source=footer" class="external-link">preferably</a> template.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
